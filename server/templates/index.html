<!-- server/templates/index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CVE Browser</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      input,
      button {
        padding: 8px;
        margin: 4px;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 10px;
      }
      th,
      td {
        border: 1px solid #ddd;
        padding: 8px;
      }
      th {
        background: #f4f4f4;
      }
      .toolbar {
        margin-bottom: 10px;
      }
      .toolbar a {
        margin-left: 8px;
        text-decoration: none;
      }
      .toolbar a button {
        cursor: pointer;
      }
      #title {
        text-align: center;
        background-color: cyan;
        padding: 10px;
      }
    </style>
    <!-- Paste this just before </body> -->
    <script>
      console.log("INLINE findCVE script loaded");

      // Guarantee a working Find CVE handler that does not depend on app.js
      window.findCVE = async function () {
        try {
          console.log("findCVE() called");
          const input = document.getElementById("cveInput");
          if (!input) {
            alert("CVE input element not found in DOM.");
            console.error("findCVE: cveInput element missing");
            return;
          }
          const id = input.value.trim();
          if (!id) {
            alert("Please enter a CVE ID (e.g. CVE-2025-12345)");
            return;
          }
          console.log("Attempting to fetch CVE:", id);

          const res = await fetch("/api/cve/" + encodeURIComponent(id));
          console.log("Fetch returned status:", res.status);

          if (res.status === 404) {
            alert("CVE not found: " + id);
            return;
          }
          if (!res.ok) {
            const txt = await res.text().catch(() => "");
            alert("Error fetching CVE: " + res.status + " â€” " + txt);
            console.error("findCVE fetch error:", res.status, txt);
            return;
          }

          const data = await res.json();
          console.log("CVE data:", data);

          const container = document.getElementById("results");
          container.innerHTML = `<h3>${data.id}</h3>
          <p><strong>Published:</strong> ${data.published || ""} 
             <strong>CVSS:</strong> ${data.cvss_v3_score || ""}</p>
          <p>${data.summary || ""}</p>
          <pre>${JSON.stringify(data.raw || {}, null, 2)}</pre>`;

          // make sure charts / png area are hidden (same behaviour as showCVE)
          const png = document.getElementById("pngCharts");
          if (png) png.style.display = "None";
        } catch (err) {
          console.error("findCVE unexpected error:", err);
          alert("Unexpected error in findCVE: " + (err.message || err));
        }
      };
    </script>
  </head>
  <body>
    <h1 id="title">G-19 CVE Browser</h1>
    <div style="text-align: center">
      <input id="vendorInput" placeholder="Search vendor (e.g. microsoft)" />
      <input id="productInput" placeholder="Search product (e.g. openssl)" />
      <button id="searchBtn">Search</button>
      <button id="recentBtn">Recent CVEs</button>
      <button id="topBtn">Top Products</button>
      <button id="statsBtn">Stats</button>
      <button id="modelBtn">Model Severity Analysis</button>
      <button
        id="impactCsvBtn"
        onclick="window.location.href='/api/export/impact';"
      >
        Download Impact CSV
      </button>

      <button
        id="attackCsvBtn"
        onclick="window.location.href='/api/export/attack-vector';"
      >
        Download Attack Vector CSV
      </button>
    </div>

    <div>
      <input
        id="cveInput"
        placeholder="Enter CVE ID (e.g. CVE-2025-12345)"
        style="width: 220px"
      />
      <button id="cveBtn" onclick="findCVE()">Find CVE</button>
    </div>

    <div id="pngCharts" style="margin-top: 20px; display: none">
      <h3>Saved Graphs (from offline advanced_analysis.py)</h3>
      <img
        id="imgMonthly"
        src="/static/cve_monthly_counts.png"
        alt="CVE monthly counts graph"
        style="max-width: 100%; margin-bottom: 10px"
      />
      <img
        id="imgSeverity"
        src="/static/cve_severity_trend.png"
        alt="CVE severity trend graph"
        style="max-width: 100%"
      />
    </div>

    <div id="results"></div>
    <!-- dynamic charts (Chart.js) -->
    <div id="charts" style="margin-top: 20px">
      <canvas id="monthlyChart"></canvas>
      <canvas id="severityChart"></canvas>
      <canvas id="modelTrendChart"></canvas>
      <!-- NEW -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/app.js"></script>
  </body>
</html>
